<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ contest['title'] }}</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 클래식 무드 폰트 -->
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

  <!-- 커스텀 CSS (배경 .angel-bg는 기존 그대로 사용) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body class="angel-bg min-h-screen text-stone-700">
  <!-- 은은한 화이트 베일 오버레이 (배경은 그대로, 가독성 ↑) -->
  <div class="fixed inset-0 pointer-events-none bg-white/55"></div>

  <main class="relative max-w-6xl mx-auto px-4 py-8">
    <!-- 헤더 -->
    <header class="flex flex-col items-center gap-3 mb-8 text-center">
      <h1 class="halo font-semibold tracking-wide"
          style="font-family:'Playfair Display','Marcellus',serif;">
        <span class="text-4xl sm:text-5xl md:text-6xl">{{ contest['title'] }}</span>
      </h1>

      <!-- ✨ 결과 버튼 (상태가 closed일 때만 보임) -->
       {% if contest['status'] == 'closed' %}
       <a href="{{ url_for('results') }}" class="btn-angel mt-2">결과 보기</a>
       {% endif %}

      <!-- 상태 배지 -->
      {% set s = contest['status'] %}
      {% if s == 'submission' %}
        {% set badge = 'bg-amber-100/80 text-amber-800 ring-1 ring-amber-200' %}
        {% set label = 'Submission' %}
      {% elif s == 'voting' %}
        {% set badge = 'bg-emerald-100/80 text-emerald-800 ring-1 ring-emerald-200' %}
        {% set label = 'Voting' %}
      {% else %}
        {% set badge = 'bg-rose-100/80 text-rose-800 ring-1 ring-rose-200' %}
        {% set label = 'Closed' %}
      {% endif %}
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm {{ badge }}">
        <span class="i-angel"></span>{{ label }}
      </span>

      <p class="text-sm text-stone-600">남은 표:
        <span class="font-semibold">{{ votes_left }}</span> / {{ contest['votes_per_user'] }}
      </p>
    </header>

    <!-- 플래시 메시지 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-6">
          {% for category, msg in messages %}
            {% set tone = 'info' %}
            {% if category == 'ok' %}{% set tone = 'ok' %}{% endif %}
            {% if category == 'error' %}{% set tone = 'error' %}{% endif %}
            <div class="alert-{{ tone }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- 제출 폼 (제출 단계 & 아직 미제출일 때만) -->
    {% if contest['status'] == 'submission' and not i_submitted %}
      <section class="glass p-5 rounded-2xl shadow-xl mb-8">
        <h2 class="section-title mb-4">코디 제출</h2>
        <form method="post" action="{{ url_for('submit') }}" enctype="multipart/form-data" class="space-y-3">
          <input type="text" name="title" placeholder="닉네임/미니코드를 입력하세요. ex)은연 incag"
            class="input angel-input" />
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input type="text" name="image_url" placeholder="이미지 URL (파일을 첨부하기 어려운 경우 url 사용 가능)"
              class="input angel-input" />
            <input type="file" name="image_file" accept="image/*"
              class="file-input angel-input" />
          </div>
          <button type="submit" class="btn-angel">제출하기</button>
        </form>
      </section>
    {% endif %}

    <!-- 갤러리 -->
    {% if show_gallery %}
      <section>
        <h2 class="section-title mb-4">Gallery</h2>

        {% if outfits|length == 0 %}
          <div class="glass p-6 rounded-2xl text-center text-stone-500">아직 제출된 코디가 없습니다.</div>
        {% else %}
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            {% for o in outfits %}
              <article class="card-angel group relative">
                <!-- 관리자 버튼 -->
                {% if show_admin %}
                  <form method="post" action="{{ url_for('admin_delete', oid=o['id']) }}"
                        class="absolute z-10 right-3 top-3">
                    <button type="submit" class="admin-x" title="삭제">×</button>
                  </form>

                  <form method="post" action="/admin/close" style="margin-top:1rem;"onsubmit="return confirm('정말 지금 투표를 종료할까요?');">
                    <button class="btn-danger">투표 종료</button>
                  </form>
                {% endif %}

                <div class="overflow-hidden rounded-t-2xl">
                  <img src="{{ o['image_url'] }}" alt="{{ o['title'] or 'Outfit' }}"
                       class="w-full h-64 object-cover group-hover:scale-[1.03] transition-transform duration-500" />
                </div>
                <div class="p-4 text-center">
                  <h3 class="font-semibold text-lg mb-1">{{ o['title'] or 'Untitled Outfit' }}</h3>
                  <p class="text-stone-600 text-sm mb-3">
                    <span class="inline-flex items-center gap-1">
                      <span class="i-heart"></span>
                      표 <strong>{{ counts.get(o['id'], 0) }}</strong>
                    </span>
                  </p>

                  {% if contest['status'] == 'voting' %}
                    <form method="post" action="{{ url_for('vote', oid=o['id']) }}">
                      <button type="submit" class="btn-vote">
                        투표하기
                      </button>
                    </form>
                  {% else %}
                    <div class="text-xs text-stone-500 italic">지금은 투표 기간이 아닙니다</div>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          </div>
        {% endif %}
      </section>
    {% else %}
      <section class="glass p-6 rounded-2xl text-center text-stone-600">
        제출을 완료하면 갤러리를 볼 수 있습니다.
      </section>
    {% endif %}

    {% if show_admin %}
      <section class="mt-8 text-center">
        <form method="post" action="{{ url_for('admin_delete_all') }}">
          <button type="submit" class="btn-ghost">[관리자] 모든 코디 삭제</button>
        </form>
      </section>
      <form method="post" action="/admin/close" style="margin-top:1rem;"onsubmit="return confirm('정말 지금 투표를 종료할까요?');">
        <button class="btn-danger">투표 종료</button>
      </form>
    {% endif %}

  </main>
</body>
</html>


