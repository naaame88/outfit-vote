<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ contest['title'] }}</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 폰트 & 커스텀 CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body class="angel-bg min-h-screen text-stone-700">
  <div class="fixed inset-0 pointer-events-none bg-white/50"></div>

  <main class="relative max-w-6xl mx-auto px-4 py-8">
    <!-- 헤더 -->
    <header class="flex items-center justify-between gap-3 mb-6">
      <h1 class="halo text-3xl md:text-4xl font-semibold tracking-wide"
          style="font-family:'Playfair Display','Marcellus',serif;">
        {{ contest['title'] }}
      </h1>

      {% set s = contest['status'] %}
      {% if s == 'submission' %}
        {% set badge = 'bg-amber-100/80 text-amber-800 ring-1 ring-amber-200' %}
        {% set label = 'Submission' %}
      {% elif s == 'voting' %}
        {% set badge = 'bg-emerald-100/80 text-emerald-800 ring-1 ring-emerald-200' %}
        {% set label = 'Voting' %}
      {% else %}
        {% set badge = 'bg-rose-100/80 text-rose-800 ring-1 ring-rose-200' %}
        {% set label = 'Closed' %}
      {% endif %}
      <span class="pill {{ badge }}">{{ label }}</span>
    </header>

    <!-- 투표 기간 안내 -->
    {% if s == 'voting' and contest['voting_opened_at'] and contest['voting_ends_at'] %}
      <div class="mb-4 text-sm text-stone-600">
        <strong>투표 기간</strong> ·
        {{ contest['voting_opened_at'] }} ~ {{ contest['voting_ends_at'] }} (UTC)
      </div>
    {% endif %}

    <!-- 플래시 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, msg in messages %}
            {% set tone = 'alert-ok' %}
            {% if category in ['error','warning'] %}{% set tone = 'alert-error' %}{% endif %}
            <div class="{{ tone }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- 제출 영역 (제출 단계 or 이미 제출한 경우 갤러리 노출 로직은 서버에서 show_gallery로 처리) -->
    {% if s == 'submission' %}
      <section class="card-angel p-4 md:p-6 mb-6">
        <h2 class="section-title mb-3">코디 제출</h2>
        <form class="grid md:grid-cols-2 gap-4" action="{{ url_for('submit') }}" method="post" enctype="multipart/form-data">
          <div>
            <label class="block mb-2 text-sm">제목</label>
            <input name="title" class="input angel-input" placeholder="예: Angel Heart #1" />
          </div>
          <div>
            <label class="block mb-2 text-sm">이미지 URL (선택)</label>
            <input name="image_url" class="input angel-input" placeholder="https://example.com/image.jpg" />
          </div>
          <div>
            <label class="block mb-2 text-sm">이미지 파일 (선택)</label>
            <input type="file" name="image_file" accept="image/*" class="file-input" />
            <p class="text-xs text-stone-500 mt-1">URL 또는 파일 중 하나만 제출해도 됩니다. (8MB 제한)</p>
          </div>
          <div class="flex items-end">
            <button class="btn-angel btn-shadow" type="submit">제출하기</button>
          </div>
        </form>
      </section>
    {% endif %}

    <!-- 투표 가능 횟수(하루) -->
    {% if s == 'voting' %}
      <div class="mb-4 text-sm">
        <strong>남은 표</strong> · 오늘 {{ votes_left }}표 남음
      </div>
    {% endif %}

    <!-- 갤러리 -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="section-title">Gallery</h2>
        <div class="text-sm text-stone-500">
          현재 제출 수: {{ entries_count }} / 최대 {{ contest['max_entries'] }}
        </div>
      </div>

      {% if outfits|length == 0 %}
        <div class="card-angel p-6 text-stone-500">아직 제출된 코디가 없습니다.</div>
      {% else %}
        <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 results-stagger">
          {% for it in outfits %}
            <article class="card-angel overflow-hidden">
              <div class="relative">
                <img src="{{ it['image_url'] }}" alt="{{ it['title'] or 'Outfit' }}" class="w-full h-56 object-cover" />
                <div class="rank-badge">{{ counts.get(it['id'], 0) }}</div>
              </div>
              <div class="p-4 space-y-2">
                <h3 class="font-semibold">{{ it['title'] or 'Untitled Outfit' }}</h3>
                <p class="text-xs text-stone-500 break-all">by {{ it['creator_id'] or 'anonymous' }}</p>

                {% if s == 'voting' %}
                  <form action="{{ url_for('vote', oid=it['id']) }}" method="post">
                    {% if votes_left > 0 %}
                      <button class="btn-vote w-full" type="submit">투표하기</button>
                    {% else %}
                      <button class="btn-ghost w-full" type="button" disabled>오늘 투표 횟수 소진</button>
                    {% endif %}
                  </form>
                {% else %}
                  <div class="text-xs text-stone-500">지금은 투표 기간이 아닙니다</div>
                {% endif %}

                {% if show_admin %}
                  <form class="mt-2" action="{{ url_for('admin_delete', oid=it['id']) }}" method="post"
                        onsubmit="return confirm('이 코디를 삭제할까요?')">
                    <button class="btn-danger w-full" type="submit">관리자: 삭제</button>
                  </form>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        </div>
      {% endif %}
    </section>

    <!-- 관리자 -->
    <section class="mt-8">
      <h2 class="section-title mb-3">관리자</h2>
      {% if show_admin %}
        <div class="flex flex-wrap gap-2">
          <form action="{{ url_for('admin_delete_all') }}" method="post"
                onsubmit="return confirm('모든 제출을 삭제할까요?')">
            <button class="btn-outline btn-shadow" type="submit">전체 삭제</button>
          </form>
          <form action="{{ url_for('admin_start_voting_5days') }}" method="post">
            <button class="btn-angel btn-shadow" type="submit">투표 시작 ({{ contest['votes_per_user'] }}표/일, {{ (contest['voting_ends_at'] and '지정됨') or '기본 5일' }})</button>
          </form>
          <form action="{{ url_for('admin_close') }}" method="post">
            <button class="btn-angel btn-shadow" type="submit">투표 강제 종료</button>
          </form>
          <form action="{{ url_for('admin_reset') }}" method="post"
                onsubmit="return confirm('전체 초기화 후 제출 단계로 되돌립니다. 진행할까요?')">
            <button class="btn-outline btn-shadow" type="submit">전체 초기화</button>
          </form>
        </div>
        <div class="text-sm text-stone-500 mt-2">
          상태 확인: <a class="underline" href="{{ url_for('admin_status') }}">/admin/status</a>
        </div>
      {% else %}
        <div class="text-sm">
          <a class="underline" href="{{ url_for('index') }}?key={{ 'changeme' }}">관리자 로그인</a>
          <span class="text-stone-500">· 배포 시 <code>ADMIN_KEY</code> 환경변수를 설정하세요.</span>
        </div>
      {% endif %}
    </section>
  </main>
</body>
</html>



